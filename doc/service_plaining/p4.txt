SCOPO DI QUESTO PROMPT

Questo prompt definisce ESATTAMENTE:
- quali azioni backend devono essere eseguite
- in risposta alle modifiche effettuate dal frontend
- con quali vincoli temporali
- con quali effetti collaterali sugli ordini
- con quali garanzie di atomicità e consistenza

NON implementare UI.
NON implementare fetch frontend.
NON modificare lo schema DB.
NON introdurre nuove regole non esplicitate qui.

PRINCIPIO FONDAMENTALE (VINCOLANTE)

Nessuna operazione backend deve avere effetti su:
- settimane passate
- giorni passati
- il giorno corrente

Sono modificabili SOLO:
- giorni futuri della settimana corrente
- giorni di settimane future

Se una richiesta viola anche solo parzialmente questo principio:
- l’operazione deve essere abortita
- nessuna modifica al database

Tutte le operazioni devono essere:
- atomiche
- transazionali
- idempotenti lato effetti finali

--------------------------------------------------

1) SALVATAGGIO GLOBAL CONSTRAINTS SETTIMANALI

Input:
- week_start
- week_end
- max_orders_per_slot
- max_pending_time

Precondizioni:
- la settimana NON deve essere passata
- se è la settimana corrente:
  - le modifiche si applicano SOLO ai giorni futuri
- se è una settimana futura:
  - le modifiche si applicano a tutta la settimana

Azioni:
- aggiornare i valori globali della settimana
- aggiornare i time slot FUTURI interessati

Gestione riduzione capienza:
- per ogni time slot coinvolto:
  - se numero ordini > nuova capienza:
    - mantenere gli ordini con numero ordine più basso
    - marcare come REJECTED gli ordini con numero ordine più alto
- gli ordini rejected NON devono subire ulteriori modifiche

--------------------------------------------------

2) ATTIVAZIONE DI UN GIORNO LAVORATIVO

Input:
- data del giorno
- orario di inizio (start)
- orario di fine (end)

Precondizioni:
- il giorno deve essere FUTURO
- il giorno NON deve essere:
  - passato
  - giorno corrente

Azioni:
- creare il working_day
- generare i time slot compresi tra start e end (end escluso)
- per ogni time slot creato:
  - max_orders = global constraint della settimana
  - max_pending_time = global constraint della settimana

Vincoli:
- la durata del time slot è fissa
- letta da configurazione centrale
- start ed end sono già normalizzati dal frontend

--------------------------------------------------

3) DISATTIVAZIONE DI UN GIORNO LAVORATIVO

Input:
- data del giorno

Precondizioni:
- il giorno deve essere FUTURO
- NON deve essere:
  - passato
  - giorno corrente

Azioni OBBLIGATORIE (ordine vincolante):
1. per ogni time slot del giorno:
   - marcare come REJECTED TUTTI gli ordini associati
2. cancellare TUTTI i time slot del giorno
3. cancellare il working_day

Nota:
- questa operazione è distruttiva
- deve essere eseguita solo se interamente valida

--------------------------------------------------

4) MODIFICA ORARI DI UN GIORNO LAVORATIVO

Input:
- data del giorno
- nuovo start
- nuovo end

Precondizioni:
- il giorno deve essere FUTURO
- NON deve essere:
  - passato
  - giorno corrente

Caso A — RIDUZIONE ORARIO
Esempio:
- prima: 10:00 – 17:00
- dopo: 10:00 – 12:00

Azioni:
1. individuare i time slot FUORI dal nuovo range
2. per ciascun time slot da rimuovere:
   - marcare come REJECTED tutti gli ordini associati
3. cancellare i time slot fuori range
4. mantenere invariati i time slot validi

Caso B — ESTENSIONE ORARIO
Esempio:
- prima: 10:00 – 12:00
- dopo: 10:00 – 15:00

Azioni:
1. generare i nuovi time slot mancanti
2. applicare i global constraints correnti
3. NON toccare i time slot esistenti

--------------------------------------------------

5) GARANZIE E INVARIANTI

- Nessun ordine già marcato come REJECTED può tornare in altro stato
- Nessuna operazione può creare effetti retroattivi
- Tutte le modifiche devono avvenire in transazione
- In caso di errore:
  - rollback completo
  - nessuno stato intermedio persistito

--------------------------------------------------

OBIETTIVO DI QUESTO PROMPT

Definire in modo non ambiguo:
- il comportamento backend
- le azioni da eseguire per ogni tipo di modifica
- l’ordine corretto delle operazioni
- le condizioni di validità

NON implementare:
- controller
- repository
- policy
- test

Questo prompt descrive il COMPORTAMENTO, non il codice.
