PROMPT 6 — Backend contract & polling

Admin · Work Service

Scopo del prompt

Definire in modo rigoroso:

quali endpoint devono esistere

che dati devono restituire

come devono essere strutturati

come devono supportare fetch iniziale, polling, update stato ordine

senza rompere stabilità delle selezioni lato frontend

❌ Vietato inventare campi
❌ Vietato introdurre logica UI
❌ Vietato modificare selezioni admin durante polling

PRINCIPIO CARDINE (DA NON VIOLARE)

Il polling NON deve MAI alterare lo stato di selezione corrente dell’admin.

Il backend:

restituisce fotografie aggiornate

non forza reset

non invalida selezioni attive

Il frontend:

aggiorna i dati

mantiene il contesto selezionato

1️⃣ FETCH INIZIALE — WORK SERVICE
Endpoint
GET /api/admin/work-service?date=YYYY-MM-DD


⚠️ date è OBBLIGATORIO
⚠️ Se non passato → errore

Response shape (obbligatoria)
{
  "date": "2026-01-17",
  "currentTimeSlotId": "12:00-12:15" | null,

  "timeSlots": [
    {
      "id": "12:00-12:15",
      "start": "12:00",
      "end": "12:15",
      "counts": {
        "pending": 3,
        "confirmed": 6,
        "ready": 4,
        "picked_up": 2
      }
    }
  ],

  "orders": [
    {
      "id": 13,
      "nickname": "Luca",
      "state": "confirmed",
      "timeSlotId": "12:00-12:15",
      "ingredients": {
        "bread": ["CB"],
        "meat": ["PR"],
        "cheese": ["MO"],
        "vegetable": ["LT"],
        "sauce": ["MA"],
        "other": []
      }
    }
  ]
}

2️⃣ PENDING — STATO SPECIALE (CHIARIMENTO)

pending è uno stato reale

NON compare nelle pipeline

compare solo:

nel badge del time slot

nei conteggi

❌ pending NON deve MAI comparire in:

righe di stato

card ordine pipeline

3️⃣ POLLING (OGNI 5 SECONDI)
Endpoint
GET /api/admin/work-service/poll?date=YYYY-MM-DD


Stessa date selezionata nello scheduler.

Regole assolute del polling

Il backend può:

aggiungere nuovi ordini

far passare ordini pending → confirmed

aggiornare i contatori dei time slot

Il backend NON DEVE:

cambiare ordine delle liste arbitrariamente

rimuovere ordini esistenti

modificare ID

resettare stati selezionati

Differenza rispetto al fetch iniziale

Il polling restituisce lo stesso schema, ma:

è trattato come aggiornamento incrementale

il frontend decide cosa aggiornare

le selezioni attive restano invariate

4️⃣ SELEZIONE TIME SLOT

Il backend:

non deve sapere quale time slot è selezionato

restituisce solo currentTimeSlotId come suggerimento iniziale

Il frontend:

può ignorarlo

può mantenerlo

non deve essere forzato dal polling

5️⃣ UPDATE STATO ORDINE (DROPDOWN & CTA)
Endpoint
POST /api/admin/orders/{orderId}/state

Payload
{
  "state": "confirmed" | "ready" | "picked_up"
}

Regole di stato

Il backend accetta qualsiasi stato valido

Il backend non fa validazioni UX

Il backend aggiorna solo il campo state

⚠️ Nessuna conferma
⚠️ Nessun rollback automatico

Response
{
  "success": true,
  "order": {
    "id": 13,
    "state": "ready"
  }
}

6️⃣ ORDINAMENTO DATI
Obblighi backend

ordini sempre ordinati per id ASC

mai ordinare per stato

mai ordinare per tempo di update

Questo vale per:

fetch iniziale

polling

update risposta

7️⃣ STABILITÀ SELEZIONE (PUNTO CRITICO)

Caso reale:

admin seleziona:

time slot 12:00–12:15

ordine #13

arriva polling

Il backend:

può aggiornare counts

può aggiungere un nuovo ordine #21

può spostare #18 da pending a confirmed

❌ MA NON:

rimuovere #13

cambiare il suo ID

spostarlo silenziosamente in altra struttura

OBIETTIVO FINALE

Il backend deve comportarsi come:

una sorgente di verità statica + aggiornamenti incrementali,
non come un sistema che decide cosa l’admin sta guardando.